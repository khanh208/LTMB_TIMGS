    <!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Hỗ trợ Chat - Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .chat-list { height: 80vh; overflow-y: auto; border-right: 1px solid #ddd; }
        .chat-box { height: 70vh; overflow-y: auto; background: #f8f9fa; padding: 15px; }
        .message { padding: 8px 12px; border-radius: 10px; margin-bottom: 8px; max-width: 70%; }
        .msg-me { background: #007bff; color: white; margin-left: auto; }
        .msg-other { background: #e9ecef; color: black; }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-primary px-4">
        <span class="navbar-brand mb-0 h1">MentorMatch Admin</span>
        <div>
            <a href="dashboard.html" class="text-white me-3">Duyệt Gia Sư</a>
            <a href="chat.html" class="text-white me-3 fw-bold text-decoration-underline">Hỗ trợ Chat</a>
            <button onclick="logout()" class="btn btn-sm btn-light text-primary">Đăng xuất</button>
        </div>
    </nav>

    <div class="container-fluid mt-3">
        <div class="row">
            <div class="col-md-3 chat-list">
                <h5 class="p-2 border-bottom">Hộp thoại</h5>
                <div class="list-group" id="roomList">
                    </div>
            </div>

            <div class="col-md-9">
                <div class="card">
                    <div class="card-header bg-white fw-bold" id="chatHeader">Chọn một cuộc trò chuyện</div>
                    <div class="card-body chat-box" id="chatBox"></div>
                    <div class="card-footer d-flex">
                        <input type="text" id="msgInput" class="form-control me-2" placeholder="Nhập tin nhắn..." disabled>
                        <button class="btn btn-primary" onclick="sendMessage()" id="sendBtn" disabled>Gửi</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="admin.js"></script>
    <script>
        checkAuth();
        let currentRoomId = null;
        let pollingInterval = null;

            async function loadRooms() {
            const rooms = await fetchAPI('/chat/rooms');
            const list = document.getElementById('roomList');
            list.innerHTML = '';

            if (rooms) {
                rooms.forEach(room => {
                    const activeClass = room.room_id === currentRoomId ? 'active' : '';
                    const badge = room.unread_count > 0 ? `<span class="badge bg-danger float-end">${room.unread_count}</span>` : '';
                    
                    list.innerHTML += `
                        <a href="#" class="list-group-item list-group-item-action ${activeClass}" 
                           onclick="selectRoom(${room.room_id}, '${room.recipient_name}')">
                            <div class="d-flex justify-content-between">
                                <strong>${room.recipient_name}</strong>
                                ${badge}
                            </div>
                            <small class="text-truncate d-block text-muted">${room.last_message || ''}</small>
                        </a>
                    `;
                });
            }
        }

        async function selectRoom(roomId, name) {
            currentRoomId = roomId;
            document.getElementById('chatHeader').innerText = `Chat với: ${name}`;
            document.getElementById('msgInput').disabled = false;
            document.getElementById('sendBtn').disabled = false;
            
            await fetchAPI(`/chat/rooms/${roomId}/read`, 'PUT');
            
            loadMessages(); 
            loadRooms();

            if (pollingInterval) clearInterval(pollingInterval);
            pollingInterval = setInterval(loadMessages, 3000);
        }

        async function loadMessages() {
            if (!currentRoomId) return;
            const messages = await fetchAPI(`/chat/rooms/${currentRoomId}`);
            const chatBox = document.getElementById('chatBox');
            
            let html = '';
            const myInfo = await fetchAPI('/users/me'); 
            const myId = myInfo.user_id;

            messages.forEach(msg => {
                const isMe = msg.sender_user_id === myId;
                html += `
                    <div class="message ${isMe ? 'msg-me' : 'msg-other'}">
                        ${msg.message_text}
                    </div>
                `;
            });
            chatBox.innerHTML = html;
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        async function sendMessage() {
            const input = document.getElementById('msgInput');
            const text = input.value.trim();
            if (!text || !currentRoomId) return;

            await fetchAPI(`/chat/rooms/${currentRoomId}`, 'POST', { messageText: text });
            input.value = '';
            loadMessages(); 
        }
        loadRooms();
        setInterval(loadRooms, 5000); 
    </script>
</body>
</html>